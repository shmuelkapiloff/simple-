# ğŸ“Š Database Schema Documentation

## ğŸ—ï¸ Database Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SIMPLE SHOP DATABASE                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚    USER     â”‚      â”‚   PRODUCT   â”‚      â”‚    CART     â”‚    â”‚
â”‚   â”‚ (××©×ª××©)     â”‚      â”‚  (××•×¦×¨)     â”‚      â”‚  (×¢×’×œ×”)     â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚        â”‚                      â”‚                      â”‚          â”‚
â”‚        â”‚                      â”‚                      â”‚          â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                               â”‚                                 â”‚
â”‚                               â–¼                                 â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                         â”‚    ORDER     â”‚                        â”‚
â”‚                         â”‚  (×”×–×× ×”)     â”‚                        â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¤ 1. USER Model (××©×ª××©)

**×ª×™××•×¨:** ×××—×¡×Ÿ ××™×“×¢ ×¢×œ ×”××©×ª××©×™× ×©×œ ×”×—× ×•×ª.

```typescript
user = {
  _id: "507f1f77bcf86cd799439011",           // ××•×˜×•××˜×™ - ××–×”×” ×™×™×—×•×“×™
  email: "user@example.com",                  // ×™×™×—×•×“×™ - ××™××™×™×œ
  password: "$2a$10$encrypted...",            // ××•×¦×¤×Ÿ (bcrypt)
  name: "×™×•×¡×™ ×›×”×Ÿ",                           // ×©× ×”××©×ª××©
  isActive: true,                             // ×”×× ×—×©×‘×•×Ÿ ×¤×¢×™×œ
  lastLogin: "2024-12-16T10:30:00Z",          // ××ª×™ ×”×ª×—×‘×¨ ×œ××—×¨×•× ×”
  createdAt: "2024-01-15T10:00:00Z",          // ××•×˜×•××˜×™ - ×ª××¨×™×š ×™×¦×™×¨×”
  updatedAt: "2024-12-16T14:30:00Z"           // ××•×˜×•××˜×™ - ×ª××¨×™×š ×¢×“×›×•×Ÿ
}
```

### User Fields:
| ×©×“×” | ×¡×•×’ | ×—×•×‘×” | ×ª×™××•×¨ |
|-----|-----|------|-------|
| `_id` | ObjectId | âœ… | ××–×”×” ×™×™×—×•×“×™ ××•×˜×•××˜×™ |
| `email` | String | âœ… | ××™××™×™×œ ×™×™×—×•×“×™ ×‘×ª×—×•× |
| `password` | String | âœ… | ×¡×™×¡××” ××•×¦×¤× ×ª (bcrypt) |
| `name` | String | âœ… | ×©× ×”××©×ª××© (2-50 ×ª×•×•×™×) |
| `isActive` | Boolean | âŒ | ×‘×¨×™×¨×ª ××—×“×œ: true |
| `lastLogin` | Date | âŒ | ××ª×™ ×”×ª×—×‘×¨ ×‘×¤×¢× ×”××—×¨×•× ×” |
| `createdAt` | Date | âœ… | ××•×˜×•××˜×™ |
| `updatedAt` | Date | âœ… | ××•×˜×•××˜×™ |

**×©×™××•×©:**
- âœ… ×”×ª×—×‘×¨×•×ª ×•×™×¦×™×¨×ª ×—×©×‘×•×Ÿ
- âœ… ×–×™×”×•×™ ××©×ª××© ×œ-JWT
- âœ… ×ª×™×•×’ ×”×–×× ×•×ª ×•×¢×¨×™×
- âœ… ×©××™×¨×ª ×¢×’×œ×•×ª ×©×œ ××©×ª××© ××—×•×‘×¨

---

## ğŸ“¦ 2. PRODUCT Model (××•×¦×¨)

**×ª×™××•×¨:** ×××—×¡×Ÿ ××™×“×¢ ×¢×œ ×›×œ ×”××•×¦×¨×™× ×‘×—× ×•×ª.

```typescript
product = {
  _id: "507f1f77bcf86cd799439021",           // ××•×˜×•××˜×™
  sku: "SHIRT-BLU-M",                        // ×™×™×—×•×“×™ - ××–×”×” ×¢×¡×§×™
  name: "×—×•×œ×¦×” ×›×—×•×œ×”",                       // ×©× ×”××•×¦×¨
  description: "×—×•×œ×¦×ª ×›×•×ª× ×” ××™×›×•×ª×™×ª...",     // ×ª×™××•×¨ ××¤×•×¨×˜
  price: 99.90,                              // ×”××—×™×¨ ×”× ×•×›×—×™! â† ×—×©×•×‘ ×œ×¢×’×œ×”
  category: "×‘×’×“×™×",                        // ×§×˜×’×•×¨×™×” (×œ×¡×™× ×•×Ÿ)
  image: "https://cdn.shop.com/shirt.jpg",  // URL ×©×œ ×”×ª××•× ×”
  featured: true,                            // ××•×¦×¨ ××•××œ×¥ (×‘×¢××•×“ ×‘×™×ª)
  stock: 25,                                 // ×›××•×ª ×‘××œ××™
  rating: 4.5,                               // ×“×™×¨×•×’ ×××•×¦×¢ (0-5)
  isActive: true,                            // ××•×¦×’ ×‘×—× ×•×ª (true) ××• ××•×¡×ª×¨ (false)
  createdAt: "2024-01-15T10:00:00Z",         // ××•×˜×•××˜×™
  updatedAt: "2024-12-16T14:30:00Z"          // ××•×˜×•××˜×™
}
```

### Product Fields:
| ×©×“×” | ×¡×•×’ | ×—×•×‘×” | ×™×™×—×•×“×™ | ×ª×™××•×¨ |
|-----|-----|------|--------|-------|
| `_id` | ObjectId | âœ… | ×›×Ÿ | ××–×”×” ××•×˜×•××˜×™ |
| `sku` | String | âœ… | ×›×Ÿ | Stock Keeping Unit - ××–×”×” ×¢×¡×§×™ |
| `name` | String | âœ… | ×œ× | ×©× ×”××•×¦×¨ |
| `description` | String | âœ… | ×œ× | ×ª×™××•×¨ ××¤×•×¨×˜ |
| `price` | Number | âœ… | ×œ× | **×”××—×™×¨ ×”× ×•×›×—×™** - ××©××© ×œ×¢×’×œ×” |
| `category` | String | âœ… | ×œ× | ×§×˜×’×•×¨×™×” (×œ×—×™×¤×•×©/×¡×™× ×•×Ÿ) |
| `image` | String | âœ… | ×œ× | URL ××• emoji |
| `featured` | Boolean | âŒ | ×œ× | ×‘×¨×™×¨×ª ××—×“×œ: false |
| `stock` | Number | âŒ | ×œ× | ×‘×¨×™×¨×ª ××—×“×œ: 0 |
| `rating` | Number | âŒ | ×œ× | ×‘×¨×™×¨×ª ××—×“×œ: 0 |
| `isActive` | Boolean | âŒ | ×œ× | ×‘×¨×™×¨×ª ××—×“×œ: true |
| `createdAt` | Date | âœ… | ×œ× | ××•×˜×•××˜×™ |
| `updatedAt` | Date | âœ… | ×œ× | ××•×˜×•××˜×™ |

**×©×™××•×©:**
- âœ… ×”×¦×’×ª ×¨×©×™××ª ××•×¦×¨×™× ×‘×—× ×•×ª
- âœ… ×—×™×¤×•×© ×•×¡×™× ×•×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×”
- âœ… ×§×¨×™××ª ×”××—×™×¨ ×”× ×•×›×—×™ ×œ×¢×’×œ×”
- âœ… ×‘×“×™×§×ª ××œ××™ ×× ×”×•×¡×¤×” ×œ×¢×’×œ×”
- âœ… ×”×¤×—×ª×ª ××œ××™ ×‘×¢×ª ×™×¦×™×¨×ª ×”×–×× ×”

---

## ğŸ›’ 3. CART Model (×¢×’×œ×ª ×§× ×™×•×ª)

**×ª×™××•×¨:** ×××—×¡×Ÿ ×¢×’×œ×•×ª ×§× ×™×•×ª ×©×œ ××©×ª××©×™× (××—×•×‘×¨×™× ×•××•×¨×—×™×).

```typescript
cart = {
  _id: "507f1f77bcf86cd799439031",           // ××•×˜×•××˜×™
  sessionId: "sess_abc123xyz789",            // ID ×©×œ ×¡×©×Ÿ (××•×¨×—)
  userId: "507f1f77bcf86cd799439011",        // ObjectId ×©×œ ××©×ª××© (×× ××—×•×‘×¨)
  items: [
    {
      product: "507f1f77bcf86cd799439021",  // ObjectId ×©×œ ××•×¦×¨
      quantity: 2,                           // ×›××•×ª
      lockedPrice: null                      // null = ××©×ª××© ×‘×—× ×•×ª, value = × ×¢×•×œ ×‘×ª×©×œ×•×
    },
    {
      product: "507f1f77bcf86cd799439022",
      quantity: 1,
      lockedPrice: null
    }
  ],
  total: 199.80,                             // ×¡×›×•× ×›×•×œ×œ ××—×•×©×‘
  createdAt: "2024-12-16T10:00:00Z",         // ××•×˜×•××˜×™
  updatedAt: "2024-12-16T14:30:00Z"          // ××•×˜×•××˜×™
}
```

### Cart Fields:
| ×©×“×” | ×¡×•×’ | ×—×•×‘×” | ×ª×™××•×¨ |
|-----|-----|------|-------|
| `_id` | ObjectId | âœ… | ××•×˜×•××˜×™ |
| `sessionId` | String | âœ… | ××–×”×” ×¡×©×Ÿ (×¢×‘×•×¨ ××•×¨×—×™×) |
| `userId` | ObjectId | âŒ | ObjectId ×©×œ ××©×ª××© (×× ××—×•×‘×¨) |
| `items[]` | Array | âœ… | ××¢×¨×š ×©×œ ×¤×¨×™×˜×™× ×‘×¢×’×œ×” |
| `items[].product` | ObjectId | âœ… | ×§×™×©×•×¨ ×œ-Product |
| `items[].quantity` | Number | âœ… | ×›××•×ª (min: 1) |
| `items[].lockedPrice` | Number | âŒ | null = ××—×™×¨ ×¢×“×›× ×™, ×¢×¨×š = × ×¢×•×œ |
| `total` | Number | âŒ | ×¡×›×•× ×›×•×œ×œ ××—×•×©×‘ |
| `createdAt` | Date | âœ… | ××•×˜×•××˜×™ |
| `updatedAt` | Date | âœ… | ××•×˜×•××˜×™ |

### âš™ï¸ Cart Logic:
```
×¢×’×œ×” ×‘×¢×’×œ×” = ××—×™×¨ ×¢×“×›× ×™?
â”œâ”€ ×× lockedPrice = null â†’ YES, ××©×ª××©×™× ×‘Ù€ product.price ×”× ×•×›×—×™
â””â”€ ×× lockedPrice = 150 â†’ NO, ××©×ª××©×™× ×‘×¢×¨×š ×”× ×¢×•×œ (150)

×¡×›×•× ×›×•×œ×œ:
total = Î£ (item.lockedPrice ?? product.price) Ã— item.quantity

âš ï¸ ×—×©×•×‘: ×¢×“ ×¨×’×¢ Checkout ×”××—×™×¨ ×ª××™×“ ×¢×“×›× ×™!
```

**×©×™××•×©:**
- âœ… ×©××™×¨×ª ×¤×¨×™×˜×™× ×œ××•×¨×— (sessionId)
- âœ… ×©××™×¨×ª ×¤×¨×™×˜×™× ×œ××©×ª××© ××—×•×‘×¨ (userId)
- âœ… ×”×¦×’×ª ×¢×’×œ×” ×¢×“×›× ×™×ª ×¢× ××—×™×¨×™× ×¢×“×›× ×™×™×
- âœ… ×—×™×©×•×‘ ×¡×›×•× ×›×•×œ×œ

---

## ğŸ“‹ 4. ORDER Model (×”×–×× ×”)

**×ª×™××•×¨:** ×××—×¡×Ÿ ×”×–×× ×•×ª ×©×”×•×©×œ××• ×©×œ ××©×ª××©×™×.

```typescript
order = {
  _id: "507f1f77bcf86cd799439041",           // ××•×˜×•××˜×™
  user: "507f1f77bcf86cd799439011",          // ObjectId ×©×œ ××©×ª××©
  orderNumber: "ORD-2024-12-16-001",         // ×™×™×—×•×“×™ - ××¡×¤×¨ ×”×–×× ×”
  items: [
    {
      product: "507f1f77bcf86cd799439021",   // ObjectId ×©×œ ××•×¦×¨
      name: "×—×•×œ×¦×” ×›×—×•×œ×”",                    // ×©× ×”××•×¦×¨ (snapshot)
      price: 99.90,                           // ××—×™×¨ ×‘×¨×’×¢ ×”×”×–×× ×” (× ×¢×•×œ!)
      quantity: 2,                            // ×›××•×ª
      image: "https://cdn.shop.com/shirt.jpg" // URL (optional)
    }
  ],
  totalAmount: 199.80,                       // ×¡×›×•× ×¡×•×¤×™ ×©×œ ×”×”×–×× ×”
  status: "pending",                         // pending | processing | shipped | delivered | cancelled
  paymentMethod: "credit_card",              // credit_card | paypal | cash_on_delivery
  paymentStatus: "pending",                  // pending | paid | failed | refunded
  shippingAddress: {
    street: "×¨×—×•×‘ ×”×¨×¦×œ 10",
    city: "×ª×œ ××‘×™×‘",
    postalCode: "67890",
    country: "Israel"
  },
  notes: "×©×œ×— ×‘×¢×“×™×¤×•×ª ×’×‘×•×”×”",                // ×”×¢×¨×•×ª ××•×¤×¦×™×•× ×œ×™×•×ª
  estimatedDelivery: "2024-12-20T23:59:59Z", // ×ª××¨×™×š ××©×•×¢×¨
  createdAt: "2024-12-16T10:00:00Z",         // ××•×˜×•××˜×™
  updatedAt: "2024-12-16T14:30:00Z"          // ××•×˜×•××˜×™
}
```

### Order Fields:
| ×©×“×” | ×¡×•×’ | ×—×•×‘×” | ×™×™×—×•×“×™ | ×ª×™××•×¨ |
|-----|-----|------|--------|-------|
| `_id` | ObjectId | âœ… | ×›×Ÿ | ××•×˜×•××˜×™ |
| `user` | ObjectId | âœ… | ×œ× | ×§×™×©×•×¨ ×œ-User |
| `orderNumber` | String | âœ… | ×›×Ÿ | ××¡×¤×¨ ×”×–×× ×” ×™×™×—×•×“×™ |
| `items[]` | Array | âœ… | ×œ× | ×¤×¨×™×˜×™× ×‘×”×–×× ×” |
| `items[].product` | ObjectId | âœ… | ×œ× | ×§×™×©×•×¨ ×œ-Product |
| `items[].name` | String | âœ… | ×œ× | ×©× ×”××•×¦×¨ (snapshot) |
| `items[].price` | Number | âœ… | ×œ× | **××—×™×¨ × ×¢×•×œ** ×‘×¨×’×¢ ×”×”×–×× ×” |
| `items[].quantity` | Number | âœ… | ×œ× | ×›××•×ª (min: 1) |
| `items[].image` | String | âŒ | ×œ× | URL ××• emoji |
| `totalAmount` | Number | âœ… | ×œ× | ×¡×›×•× ×›×•×œ×œ ×¡×•×¤×™ |
| `status` | String | âœ… | ×œ× | pending/processing/shipped/delivered/cancelled |
| `paymentMethod` | String | âœ… | ×œ× | credit_card/paypal/cash_on_delivery |
| `paymentStatus` | String | âœ… | ×œ× | pending/paid/failed/refunded |
| `shippingAddress` | Object | âœ… | ×œ× | ×›×ª×•×‘×ª ××©×œ×•×— |
| `notes` | String | âŒ | ×œ× | ×”×¢×¨×•×ª ××•×¤×¦×™×•× ×œ×™×•×ª |
| `estimatedDelivery` | Date | âŒ | ×œ× | ×ª××¨×™×š ××©×•×¢×¨ |
| `createdAt` | Date | âœ… | ×œ× | ××•×˜×•××˜×™ |
| `updatedAt` | Date | âœ… | ×œ× | ××•×˜×•××˜×™ |

### âš ï¸ Order Rules:
```
âœ… ×™×•×¦×¨×™× Order ×-Cart:
  1. ×§×•×¨××™× ××ª Cart ×”× ×•×›×—×™×ª
  2. ×œ×•×§×—×™× ××ª product.price ×”×¢×“×›× ×™
  3. ×©×•××¨×™× ×‘-Order.items[].price (LOCKED!)
  4. ×‘×“×•×§×™× ××œ××™ ×œ×›×œ ×¤×¨×™×˜
  5. ××¢×“×›× ×™× Product.stock

ğŸ“Œ Order.items[].price = SNAPSHOT ×©×œ ×”××—×™×¨ ×‘×–××Ÿ ×”×”×–×× ×”
   ×œ× ××©×ª× ×” ×›×©×”××—×™×¨ ×‘×—× ×•×ª ××©×ª× ×”!
```

**×©×™××•×©:**
- âœ… ×™×¦×™×¨×ª ×”×–×× ×” ××¢×’×œ×”
- âœ… ×¢×§×•×‘ ××—×¨×™ ×”×–×× ×”
- âœ… × ×™×”×•×œ ××©×œ×•×— ×•×ª×©×œ×•×
- âœ… ×”×™×¡×˜×•×¨×™×” ×©×œ ×”×–×× ×•×ª

---

## ğŸ”— Relationships (×§×©×¨×™× ×‘×™×Ÿ ××•×“×œ×™×)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    USER     â”‚
â”‚ (××©×ª××©)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1:N (××©×ª××© ××—×“ â†’ ×”×¨×‘×” ×”×–×× ×•×ª)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ORDER    â”‚
â”‚  (×”×–×× ×”)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ items[].product â†’ Product
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PRODUCT   â”‚
â”‚  (××•×¦×¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²
       â”‚ items[].product â†’ Product
       â”‚ 1:N (××•×¦×¨ ××—×“ â†’ ×”×¨×‘×” ×¢×’×œ×•×ª)
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚    CART     â”‚
â”‚  (×¢×’×œ×”)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ (×—×•×‘×”: sessionId ××• userId)
       â”‚
       â–¼
    USER (optional)
```

### Relationship Details:

#### ğŸ”¹ USER â†’ ORDER (1:N)
```javascript
// ××©×ª××© ××—×“ ×™×›×•×œ ×œ×”×™×•×ª ×œ×• ×”×¨×‘×” ×”×–×× ×•×ª
User._id = "user123"
Order.user = "user123" â† ×§×™×©×•×¨
Order.user = "user123" â† ×§×™×©×•×¨
```

#### ğŸ”¹ PRODUCT â†’ ORDER (N:M ×“×¨×š Order.items)
```javascript
// ××•×¦×¨ ××—×“ ×™×›×•×œ ×œ×”×™×•×ª ×‘×”×¨×‘×” ×”×–×× ×•×ª
Product._id = "prod1"
Order1.items[].product = "prod1"
Order2.items[].product = "prod1"
Order3.items[].product = "prod1"
```

#### ğŸ”¹ USER â†’ CART (1:1 ××• 0:1)
```javascript
// ××©×ª××© ××—×•×‘×¨ ××—×“ ×™×›×•×œ ×œ×”×™×•×ª ×œ×• Cart ××—×“
User._id = "user123"
Cart.userId = "user123"
```

#### ğŸ”¹ SESSION â†’ CART (1:1)
```javascript
// ×¡×©×Ÿ ××—×“ ×™×›×•×œ ×œ×”×™×•×ª ×œ×• Cart ××—×“ (×¢×‘×•×¨ ××•×¨×—×™×)
session = "sess_abc123"
Cart.sessionId = "sess_abc123"
```

#### ğŸ”¹ PRODUCT â†’ CART (N:M ×“×¨×š Cart.items)
```javascript
// ××•×¦×¨ ××—×“ ×™×›×•×œ ×œ×”×™×•×ª ×‘×”×¨×‘×” ×¢×’×œ×•×ª
Product._id = "prod1"
Cart1.items[].product = "prod1"
Cart2.items[].product = "prod1"
```

---

## ğŸ“Š Entity-Relationship Diagram (ERD)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     USER     â”‚
                    â”‚              â”‚
                    â”‚ â€¢ _id (PK)   â”‚
                    â”‚ â€¢ email      â”‚
                    â”‚ â€¢ password   â”‚
                    â”‚ â€¢ name       â”‚
                    â”‚ â€¢ isActive   â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚    â”‚
                    1:N  â”‚    â”‚ 0:1
                         â”‚    â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                                â”‚
            â–¼                                â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   ORDER    â”‚                â”‚     CART     â”‚
       â”‚            â”‚                â”‚              â”‚
       â”‚ â€¢ _id (PK) â”‚                â”‚ â€¢ _id (PK)   â”‚
       â”‚ â€¢ user(FK) â”‚                â”‚ â€¢ sessionId  â”‚
       â”‚ â€¢ items[]  â”‚                â”‚ â€¢ userId(FK) â”‚
       â”‚ â€¢ total    â”‚                â”‚ â€¢ items[]    â”‚
       â”‚ â€¢ status   â”‚                â”‚ â€¢ total      â”‚
       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                             â”‚
            â”‚ N:M (×“×¨×š items)            â”‚ N:M (×“×¨×š items)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   PRODUCT    â”‚
                    â”‚              â”‚
                    â”‚ â€¢ _id (PK)   â”‚
                    â”‚ â€¢ sku(UNIQUE)â”‚
                    â”‚ â€¢ name       â”‚
                    â”‚ â€¢ price      â”‚â—„â”€â”€ ×—×©×•×‘: ×–×” ×”××—×™×¨ ×”×¢×“×›× ×™
                    â”‚ â€¢ stock      â”‚
                    â”‚ â€¢ featured   â”‚
                    â”‚ â€¢ isActive   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
PK = Primary Key (××–×”×” ×¨××©×™)
FK = Foreign Key (××–×”×” ×—×•×¥)
N:M = Many-to-Many (×”×¨×‘×” ×œ×¨×‘×”)
1:N = One-to-Many (××—×“ ×œ×¨×‘×”)
0:1 = Zero-or-One (××¤×¡ ××• ××—×“)
```

---

## ğŸ”„ Data Flow Example: "×”×•×¡×¤×ª ××•×¦×¨ ×œ×¢×’×œ×”"

```
1. ×œ×§×•×— ×‘×—× ×•×ª:
   GET /api/products â†’ ×§×•×‘×œ ××•×¦×¨×™× ×-Product Model
   
2. Product ××—×–×™×¨:
   {
     _id: "prod1",
     name: "×—×•×œ×¦×”",
     price: 99.90,  â—„â”€â”€ ×”××—×™×¨ ×”× ×•×›×—×™
     stock: 25
   }

3. ×œ×§×•×— ×œ×•×—×¥ "×”×•×¡×£ ×œ×¢×’×œ×”":
   POST /api/cart/items
   {
     sessionId: "sess_123",
     productId: "prod1",
     quantity: 2
   }

4. Server ×‘×•×“×§:
   âœ… Product.stock >= 2? YES
   âœ… Product.isActive? YES

5. Server ××•×¡×™×£ ×œ-Cart:
   cart.items.push({
     product: "prod1",
     quantity: 2,
     lockedPrice: null  â—„â”€â”€ null = ××©×ª××© ×‘×—× ×•×ª
   })

6. Server ×—×•×©×‘ ×¡×›×•×:
   item.price = item.lockedPrice ?? product.price
   item.price = null ?? 99.90 = 99.90
   total += 99.90 * 2 = 199.80

7. ×œ×§×•×— ×¨×•××”:
   Cart: [{×—×•×œ×¦×” Ã— 2 = 199.80}]
```

---

## ğŸ”„ Data Flow Example: "×™×¦×™×¨×ª ×”×–×× ×”"

```
1. ×œ×§×•×— ×œ×•×—×¥ "×§× ×”":
   POST /api/orders
   {
     shippingAddress: {...},
     paymentMethod: "credit_card"
   }

2. Server ×§×•×‘×œ Cart ×”× ×•×›×—×™×ª:
   GET Cart where userId = user._id

3. ×œ×›×œ ×¤×¨×™×˜ ×‘×¢×’×œ×”:
   product = findById(item.product)
   price = product.price  â—„â”€â”€ ××—×™×¨ ×¢×“×›× ×™!
   
   order.items.push({
     product: product._id,
     name: product.name,
     price: price,         â—„â”€â”€ LOCKED!
     quantity: item.quantity
   })
   
   total += price * quantity
   Product.stock -= quantity  â—„â”€â”€ ×¢×“×›×•×Ÿ ××œ××™

4. Order × ×•×¦×¨×ª:
   Order.totalAmount = total
   Order.status = "pending"
   Order.paymentStatus = "pending"

5. Cart × ××—×§×ª:
   Cart.deleteOne({userId: user._id})

6. ×œ×§×•×— ×¨×•××”:
   Order Number: ORD-2024-12-16-001
   Items: [{×—×•×œ×¦×” Ã— 2 = 199.80}]
   Status: Pending
```

---

## ğŸ“Œ Key Takeaways

### âœ… Product.price
- ×–×” ×”××—×™×¨ ×”**×¢×“×›× ×™** ×©×œ ×”××•×¦×¨ ×‘×—× ×•×ª
- ××©××© ×œ×—×™×©×•×‘ ×¡×›×•× ×‘×¢×’×œ×”
- ××©××© ×œ×™×¦×™×¨×ª Order (× ×¢×•×œ ×©×!)

### âœ… Cart.items[].lockedPrice
- `null` = ××©×ª××© ×‘×—× ×•×ª (price ×¢×“×›× ×™)
- `value` = ××—×™×¨ × ×¢×•×œ (×¢×‘×•×¨ ×¢×“×™×¤×•×ª ×‘×¢×ª×™×“)
- ×–×” ×“×™×–×™×™×Ÿ ×¢×ª×™×“×™ ×œ×”× ×¢×•×œ ××—×™×¨×™×

### âœ… Order.items[].price
- **SNAPSHOT** ×©×œ ×”××—×™×¨ ×‘×–××Ÿ ×”×”×–×× ×”
- ×œ× ××©×ª× ×” ×›×©×”××—×™×¨ ×‘×—× ×•×ª ××©×ª× ×”
- ×–×” "×”×—×•×–×”" ×‘×™×Ÿ ×—× ×•×ª ×œ×œ×§×•×—

### âœ… Relationships
- User â†” Order (1:N)
- User â†” Cart (0:1)
- Product â†” Order (N:M ×“×¨×š items)
- Product â†” Cart (N:M ×“×¨×š items)

---

## ğŸš€ Queries Examples

### ×§×‘×œ ×¢×’×œ×” ×œ××©×ª××© ××—×•×‘×¨:
```javascript
Cart.findOne({ userId: user._id }).populate('items.product')
```

### ×§×‘×œ ×¢×’×œ×” ×œ××•×¨×—:
```javascript
Cart.findOne({ sessionId: sessionId }).populate('items.product')
```

### ×§×‘×œ ×”×–×× ×•×ª ×©×œ ××©×ª××©:
```javascript
Order.find({ user: user._id }).populate('items.product')
```

### ×‘×“×•×§ ××œ××™ ×©×œ ××•×¦×¨:
```javascript
const product = await Product.findById(productId);
if (product.stock < requestedQuantity) {
  throw new Error("××œ××™ ×œ× ××¡×¤×™×§");
}
```

### ×¢×“×›×Ÿ ××œ××™ ××—×¨×™ ×”×–×× ×”:
```javascript
await Product.findByIdAndUpdate(
  productId,
  { $inc: { stock: -quantity } }
);
```

---

**×©××œ×•×ª? ğŸ¤”**
